name: Prune Images

on:
  schedule:
  - cron: "7 0 * * 2"
  workflow_dispatch:

jobs:

  prune:
    name: Prune
    runs-on: ubuntu-latest

    steps:
    - name: Delete untagged images BE
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.REGISTRY_PASSWORD }}
        script: |
          const response = await github.request("GET /${{ env.OWNER }}/packages/container/${{ env.PACKAGE_NAME }}/versions",
            { per_page: ${{ env.PER_PAGE }}
          });
          for(version of response.data) {
              if (version.metadata.container.tags.length == 0) {
                  console.log("delete " + version.id)
                  const deleteResponse = await github.request("DELETE /${{ env.OWNER }}/packages/container/${{ env.PACKAGE_NAME }}/versions/" + version.id, { });
                  console.log("status " + deleteResponse.status)
              }
          }
      env:
        OWNER: holzmaster
        PACKAGE_NAME: kt-be
        PER_PAGE: 2

    - name: Delete untagged images FE
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.REGISTRY_PASSWORD }}
        script: |
          const response = await github.request("GET /${{ env.OWNER }}/packages/container/${{ env.PACKAGE_NAME }}/versions",
            { per_page: ${{ env.PER_PAGE }}
          });
          for(version of response.data) {
              if (version.metadata.container.tags.length == 0) {
                  console.log("delete " + version.id)
                  const deleteResponse = await github.request("DELETE /${{ env.OWNER }}/packages/container/${{ env.PACKAGE_NAME }}/versions/" + version.id, { });
                  console.log("status " + deleteResponse.status)
              }
          }
      env:
        OWNER: holzmaster
        PACKAGE_NAME: kt-fe
        PER_PAGE: 2
